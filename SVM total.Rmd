---
title: "SVM Total"
output: html_notebook
---


###Load libraries
```{r}
library(readr)
library(e1071)
library(Metrics)
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyr)
library(readxl)
library(caTools)
```


### load datasets
```{r}
total <- read_csv("Dataset_total.csv")

```


###Adjust the classes of the variables
```{r}

total <- total %>% mutate(Datum = as.Date(Datum))

total <- total %>% mutate(Warengruppe = as.factor(Warengruppe))
total <- total %>% mutate(Umsatz = as.numeric(Umsatz))
total <- total %>% mutate(preday_turnover = as.numeric(preday_turnover))
total <- total %>% mutate(preweek_turnover_1 = as.numeric(preweek_turnover_1))
total <- total %>% mutate(preweek_turnover_2 = as.numeric(preweek_turnover_2))
total <- total %>% mutate(preyear_turnover = as.numeric(preyear_turnover))

total <- total %>% mutate(Year = as.factor(Year))
total <- total %>% mutate(Day_of_year = as.factor(Day_of_year))
total <- total %>% mutate(Week_in_year = as.factor(Week_in_year))
total <- total %>% mutate(Day_of_month = as.factor(Day_of_month))
total <- total %>% mutate(Weekday = as.factor(Weekday))
total <- total %>% mutate(Month = as.factor(Month))

total <- total %>% mutate(Kieler_Woche = as.factor(Kieler_Woche))
total <- total %>% mutate(Weihnachtsmarkt = as.factor(Weihnachtsmarkt))
total <- total %>% mutate(Wahl = as.factor(Wahl))
total <- total %>% mutate(Wahltyp = as.factor(Wahltyp))
total <- total %>% mutate(Digitale_Woche = as.factor(Digitale_Woche))
total <- total %>% mutate(Feiertagsart = as.factor(Feiertagsart))
total <- total %>% mutate(Gesetzl_Feiertag = as.factor(Gesetzl_Feiertag))
total <- total %>% mutate(Brueckentag = as.factor(Brueckentag))
total <- total %>% mutate(Langes_Wochenende = as.factor(Langes_Wochenende))
total <- total %>% mutate(Semesterferien = as.factor(Semesterferien))
total <- total %>% mutate(Schulferien = as.factor(Schulferien))


total <- total %>% mutate(Temperatur = as.numeric(Temperatur))
total <- total %>% mutate(Bewoelkung = as.integer(Bewoelkung))
total <- total %>% mutate(Windgeschwindigkeit = as.integer(Windgeschwindigkeit))
total <- total %>% mutate(Wettercode = as.factor(Wettercode))
total <- total %>% mutate(WindFct = as.factor(WindFct))
total <- total %>% mutate(BewoelkungFct = as.factor(BewoelkungFct))
total <- total %>% mutate(WettercodeFct = as.factor(WettercodeFct))
total <- total %>% mutate(TemperaturFct   = as.factor(TemperaturFct  ))

total <- total %>% mutate(Durchschnittstemperatur_monatlich = as.numeric(Durchschnittstemperatur_monatlich))
total <- total %>% mutate(Tagestemperatur_tatsaechlich = as.numeric(Tagestemperatur_tatsaechlich))
total <- total %>% mutate(`Differenz_zum Mittel` = as.numeric(`Differenz_zum Mittel`))
total <- total %>% mutate(Kaelter_als_normal = as.factor(Kaelter_als_normal))
total <- total %>% mutate(Waermer_als_normal = as.factor(Waermer_als_normal))


total <- total %>% mutate(Neue_Jahreszeit = as.factor(Neue_Jahreszeit))
total <- total %>% mutate(Winter = as.factor(Winter))
total <- total %>% mutate(Fruehling = as.factor(Fruehling))
total <- total %>% mutate(Sommer = as.factor(Sommer))
total <- total %>% mutate(Herbst = as.factor(Herbst))
total <- total %>% mutate(Sommerzeit = as.factor(Sommerzeit))
total <- total %>% mutate(Zeit = as.factor(Zeit))

total <- total %>% mutate(Ankuenfte = as.numeric(Ankuenfte))
total <- total %>% mutate(Arbeitslose = as.numeric(Arbeitslose))
total <- total %>% mutate(Uebernachtungen = as.numeric(Uebernachtungen))
total <- total %>% mutate(Einwohnerzahl_Kiel = as.numeric(Einwohnerzahl_Kiel))

```

### Delete Wettercode due to a lot of NA's
```{r}
total <- total %>% select(-c(WettercodeFct, Wettercode))

```


### Split dataset into train and test data
```{r}
total <- na.omit(total)

## 75% of the sample size
smp_size <- floor(0.75 * nrow(total))

## set the seed to make your partition reproducible
set.seed(123)
train_ind <- sample(seq_len(nrow(total)), size = smp_size)
train_dataset_total <- total[train_ind, ]
test_dataset_total <- total[-train_ind, ]

```


### Estimation of various SVM
```{r}
svm_tune_1 <- tune(svm, Umsatz ~ Weekday + Month + preweek_turnover_1 + Semesterferien + Kieler_Woche, data=train_dataset_total, ranges=list(epsilon=seq(0.2,1,0.1),cost=2^(2:3)))



```

### Checking the prediction Quality
```{r}

# Calculating the prediction for the training data using the best model according to the grid search
pred_train <- predict(svm_tune_1$best.model, train_dataset_total)
mape(train_dataset_total$Umsatz, pred_train)

# Calculating the prediction for the test data using the best model according to the grid search
pred_test <- predict(svm_tune_1$best.model, test_dataset_total)
mape(test_dataset_total$Umsatz, pred_test)

```

